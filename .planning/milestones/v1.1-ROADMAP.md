# Milestone v1.1: Refinement & Testing

**Status:** SHIPPED 2026-02-10
**Phases:** 11-18
**Total Plans:** 3 (5 phases completed pre-GSD)

## Overview

Resolve dependency hell, harden the pipeline against edge cases and security issues, add proper test coverage, and instrument for performance monitoring. Final phase documents the WebSocket protocol for frontend integration.

## Phases

### Phase 11: Dependency Resolution

**Goal**: Working Python 3.12 venv with all pinned dependencies installed and verified. MediaPipe, TensorFlow, OpenCV all import cleanly. Webcam + MediaPipe Holistic detection confirmed working. All existing scripts run without import errors.
**Depends on**: v1.0 MVP complete
**Plans**: 1/1 complete

Plans:
- [x] 11-01: Create venv, install deps, verify environment, update PROJECT.md

**Details:**
- Created Python 3.12 venv at ml/venv/
- Resolved critical dependency conflict: mediapipe 0.10.32 removed mp.solutions (entire codebase depends on it)
- Pinned mediapipe 0.10.21 (last version with legacy API)
- Cascading version pins: tensorflow 2.16.2, numpy 1.26.4, opencv-python 4.11.0.86

### Phase 12: Consolidate Constants & Config

**Goal**: Single source of truth for ACTIONS, SEQUENCE_LENGTH, NUM_SEQUENCES in `ml/utils.py`. HOST, PORT, CONFIDENCE_THRESHOLD, STABILITY_WINDOW centralized with environment variable overrides. MODEL_PATH uses absolute path resolution.
**Depends on**: Phase 11
**Status**: Complete (implemented by Ralph loop pre-GSD)
**Evidence**: `ml/utils.py` lines 25-41 — all constants centralized, env var overrides via `SENSEAI_*`, `MODEL_PATH` uses `os.path.abspath(__file__)`. `ml/ws_server.py` imports all from `utils`.
**Plans**: 0/0 (no plans needed — work was done pre-GSD)

### Phase 13: Error Handling & Input Validation

**Goal**: WebSocket server uses specific exception types (binascii.Error, cv2.error, ValueError) instead of bare `except Exception`. Data URL parsing validated before split. Payload size limit enforced (max 5MB). Model file existence checked at startup with clear error message.
**Depends on**: Phase 12
**Status**: Complete (implemented by Ralph loop pre-GSD)
**Evidence**: `ml/ws_server.py` `decode_frame()` — 5MB limit, data URL comma check, `binascii.Error`/`ValueError` catches. Lifespan checks `os.path.isfile(MODEL_PATH)`.
**Plans**: 0/0 (no plans needed — work was done pre-GSD)

### Phase 14: Security Hardening

**Goal**: Restrict CORS to configurable allowed origins. Add try/except validation for env var type conversions. Optional API key auth on WebSocket connect.
**Depends on**: Phase 13
**Plans**: 1/1 complete

Plans:
- [x] 14-01: Env var validation, configurable CORS origins, optional API key auth

**Details:**
- Env var conversions use `_safe_int`/`_safe_float` helpers with fallback defaults
- CORS origins configurable via `SENSEAI_CORS_ORIGINS` env var, defaults to `["*"]`
- Optional API key auth via `SENSEAI_API_KEY`, rejects with close code 4003
- 17 new tests added (131 total passing)

### Phase 15: Unit Tests

**Goal**: pytest configured with test fixtures. Unit tests for `extract_keypoints()`, `decode_frame()`, `mediapipe_detection()` using mocks. Contract test for (1662,) keypoint shape. All tests pass in CI-compatible mode (no webcam required).
**Depends on**: Phase 13
**Status**: Complete (implemented by Ralph loop pre-GSD)
**Evidence**: `ml/tests/` — 21 test files, 114+ tests. `conftest.py` at two levels with MediaPipe mocking. All tests run without webcam/GPU.
**Plans**: 0/0 (no plans needed — work was done pre-GSD)

### Phase 16: Edge Case & Negative Tests

**Goal**: Tests for invalid input formats, corrupted base64 data, oversized payloads, malformed WebSocket messages. Server handles all gracefully without crashing.
**Depends on**: Phase 15
**Status**: Complete (implemented by Ralph loop pre-GSD)
**Evidence**: `ml/tests/test_decode_frame_hardened.py`, `test_ws_server.py`, `test_ws_rate_limit.py`.
**Plans**: 0/0 (no plans needed — work was done pre-GSD)

### Phase 17: Performance Instrumentation

**Goal**: Timing around MediaPipe detection and LSTM inference. Slow prediction logging (>200ms). Per-request latency metrics at `/health` endpoint.
**Depends on**: Phase 13
**Status**: Complete (implemented by Ralph loop pre-GSD)
**Evidence**: `ml/ws_server.py` — `inference_times = deque(maxlen=100)`, `time.perf_counter()` around detection+prediction, `/health` returns `avg_inference_ms`.
**Plans**: 0/0 (no plans needed — work was done pre-GSD)

### Phase 18: Protocol Docs & Modernization

**Goal**: WebSocket message schema documented (connection lifecycle, request/response formats, error codes).
**Depends on**: Phase 14
**Plans**: 1/1 complete

Plans:
- [x] 18-01: WebSocket protocol documentation (docs/WEBSOCKET.md)

**Details:**
- Created 289-line docs/WEBSOCKET.md covering complete WebSocket protocol
- Documented all 3 response types (buffering, sign_prediction, error) with JSON schemas
- 9 error conditions, health endpoint, 6 env vars, stability filter behavior
- Frontend integration tips included

---

## Milestone Summary

**Decimal Phases:** None

**Key Decisions:**
- Use mediapipe 0.10.21 (last version with mp.solutions.holistic legacy API)
- Pin tensorflow 2.16.2 (compatible with numpy<2 constraint)
- CORS defaults to ["*"] for dev; production sets SENSEAI_CORS_ORIGINS
- API key auth opt-in via SENSEAI_API_KEY; query param ?api_key=KEY
- Invalid env var values silently fall back to defaults

**Issues Resolved:**
- Python dependency conflict (mediapipe 0.10.32 removed mp.solutions)
- TensorFlow/NumPy version incompatibility chain

**Issues Deferred:** None

**Technical Debt Incurred:**
- mediapipe pinned to 0.10.21 — eventual migration to MediaPipe Tasks API needed when mp.solutions is EOL
- Python 3.12 required — cannot use 3.13+ until mediapipe supports it

---

_For current project status, see .planning/ROADMAP.md_
